<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YTRestDir.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">services</a> &gt; <span class="el_source">YTRestDir.java</span></div><h1>YTRestDir.java</h1><pre class="source lang-java linenums">/**
 * @author: Zheyi Zheng - 40266266
 * Created: 2024/10/29
 * This is the YTRestDir class. It handles the API request to YouTube.
 */
package services;

import org.json.JSONArray;
import org.json.JSONObject;

import java.net.URI;
import java.net.URISyntaxException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;

import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;
import java.util.stream.Stream;

<span class="fc" id="L25">public class YTRestDir {</span>

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/29
     * Dependency injection method for HttpURLConnection. Without this method the mock test will not work, it will trigger actual network requests.
     * @param uri a target URI
     * @return an HttpURLConnection instance connect to target uri.
     */
    protected HttpURLConnection getHttpURLConnection(URI uri) throws IOException {
<span class="fc" id="L35">        return (HttpURLConnection) uri.toURL().openConnection();</span>
    }

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/29
     * In order to allow fetch data asynchronously. I created this class to return CompletionFuture&lt;List&lt;YTResponse&gt;&gt;.
     * This class essentially is just calling the searchVideos method with supplyAsync, enable users to call it concurrently without interfering with each other's results.
     * @return the CompletableFuture. Everyone calls it can access additional asynchronous methods like thenApply.
     */
    public CompletableFuture&lt;List&lt;YTResponse&gt;&gt; searchVideosAsynch(String keyword, String url, String maxResult) {
<span class="fc" id="L46">        return CompletableFuture.supplyAsync(() -&gt; {</span>
            try {
                return searchVideos(keyword, url, maxResult);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        });
    }

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/29
     * Request 10 search result from YouTube by making GET request.
     * @param keyword keyword that user provided. Target uri that should be to YouTube. The number of the search result.
     * @return a list of YTResponse (processed by mapResponse).
     */
    public List&lt;YTResponse&gt; searchVideos(String keyword, String url, String maxResult) throws IOException {
<span class="fc" id="L63">        String API_KEY = &quot;AIzaSyC9q637eiKNR6dnssWfxTn22W9UGG-sC30&quot;;</span>
<span class="fc" id="L64">        String BASE_URL = &quot;https://www.googleapis.com/youtube/v3/search&quot;;</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        String MAX_RESULTS = (maxResult != null) ? maxResult : &quot;50&quot;;</span>
<span class="fc" id="L66">        String encodedKeyword = URLEncoder.encode(keyword, StandardCharsets.UTF_8.toString());</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        String urlString = (url != null) ? url : BASE_URL + &quot;?part=snippet&amp;q=&quot; + encodedKeyword + &quot;&amp;key=&quot; + API_KEY + &quot;&amp;maxResults=&quot; + MAX_RESULTS;</span>

        try {
<span class="fc" id="L70">            URI uri = new URI(urlString);</span>
<span class="fc" id="L71">            HttpURLConnection conn = getHttpURLConnection(uri);</span>
<span class="fc" id="L72">            conn.setRequestMethod(&quot;GET&quot;);</span>

            // Handle response code
<span class="fc" id="L75">            int responseCode = conn.getResponseCode();</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (responseCode != HttpURLConnection.HTTP_OK) {</span>
                // If not 200, just throw an IOException
<span class="fc" id="L78">                throw new IOException(&quot;HTTP error code: &quot; + responseCode);</span>
            }

            // process the response
<span class="fc" id="L82">            BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));</span>
            // Process input stream into a single string
<span class="fc" id="L84">            StringBuilder response = new StringBuilder();</span>
            String inputLine;
<span class="fc bfc" id="L86" title="All 2 branches covered.">            while ((inputLine = in.readLine()) != null) {</span>
<span class="fc" id="L87">                response.append(inputLine);</span>
            }
            // Apply the mapResponse to the string and return
<span class="fc" id="L90">            return mapResponse(response.toString());</span>
<span class="fc" id="L91">        } catch (URISyntaxException e) {</span>
<span class="fc" id="L92">            throw new IOException(&quot;Invalid URL: &quot; + e.getMessage());</span>
        }
    }



    /**
     * @author: Pulkit Bansal - 40321488
     * Created: 2024/10/29
     * Fetch Details
     */

    public CompletableFuture&lt;YTResponse&gt; getVideoDetails(String videoId) {
<span class="fc" id="L105">        String API_KEY = &quot;AIzaSyAPX6aCdEK_YnY7ebeYTU19OxELghm4zIg&quot;;</span>
<span class="fc" id="L106">        String urlString = &quot;https://www.googleapis.com/youtube/v3/videos?part=snippet&amp;id=&quot; + videoId + &quot;&amp;key=&quot; + API_KEY;</span>

<span class="fc" id="L108">        return CompletableFuture.supplyAsync(() -&gt; {</span>
            try {
                URI uri = new URI(urlString);
                HttpURLConnection conn = getHttpURLConnection(uri);
                conn.setRequestMethod(&quot;GET&quot;);

                int responseCode = conn.getResponseCode();
                if (responseCode != HttpURLConnection.HTTP_OK) {
                    throw new IOException(&quot;HTTP error code: &quot; + responseCode);
                }

                try (BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()))) {
                    StringBuilder response = new StringBuilder();
                    String inputLine;
                    while ((inputLine = in.readLine()) != null) {
                        response.append(inputLine);
                    }
                    return parseVideoDetails(response.toString());
                }
            } catch (Exception e) {
                throw new RuntimeException(&quot;Error fetching video details: &quot; + e.getMessage(), e);
            }
        });
    }

    /**
     * Helper method to parse JSON response and create a YTResponse object
     */
    public YTResponse parseVideoDetails(String jsonResponse) {
<span class="fc" id="L137">        JSONObject jsonObject = new JSONObject(jsonResponse);</span>
<span class="fc" id="L138">        JSONArray items = jsonObject.getJSONArray(&quot;items&quot;);</span>

<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (items.length() == 0) {</span>
<span class="fc" id="L141">            return null; // No video found</span>
        }

<span class="fc" id="L144">        JSONObject snippet = items.getJSONObject(0).getJSONObject(&quot;snippet&quot;);</span>
<span class="fc" id="L145">        YTResponse ytResponse = new YTResponse();</span>
<span class="fc" id="L146">        ytResponse.setTitle(snippet.getString(&quot;title&quot;));</span>
<span class="fc" id="L147">        ytResponse.setDescription(snippet.getString(&quot;description&quot;));</span>
<span class="fc" id="L148">        ytResponse.setChannelTitle(snippet.getString(&quot;channelTitle&quot;));</span>
<span class="fc" id="L149">        ytResponse.setChannelId(snippet.getString(&quot;channelId&quot;));</span>

        // Setting tags if they exist
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (snippet.has(&quot;tags&quot;)) {</span>
<span class="fc" id="L153">            List&lt;String&gt; tags = snippet.getJSONArray(&quot;tags&quot;).toList().stream()</span>
<span class="fc" id="L154">                    .map(Object::toString)</span>
<span class="fc" id="L155">                    .collect(Collectors.toList());</span>
<span class="fc" id="L156">            ytResponse.setTags(tags);</span>
        }
<span class="fc" id="L158">        return ytResponse;</span>
    }


    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/29
     * Map json response into YTResponse.
     * @param jsonResponse a json response in String.
     * @return a list of YTResponse.
     */
    private List&lt;YTResponse&gt; mapResponse(String jsonResponse) {
        // Use JSONObject to retrieve information from response string
<span class="fc" id="L171">        JSONObject jsonObject = new JSONObject(jsonResponse);</span>
<span class="fc" id="L172">        JSONArray items = jsonObject.getJSONArray(&quot;items&quot;);</span>

        // Use Stream to map the response into YTResponse object
<span class="fc" id="L175">        return Stream.iterate(0, n -&gt; n + 1)</span>
<span class="fc" id="L176">                .limit(items.length())</span>
<span class="fc" id="L177">                .map(n -&gt; {</span>
                    // For each json object, create a YTResponse instance and feed information into the instance.
                    JSONObject video = items.getJSONObject(n);
                    //System.out.println(video);
                    JSONObject snippet = video.getJSONObject(&quot;snippet&quot;);
                    YTResponse ytResponse = new YTResponse();
                    ytResponse.setTitle(video.getJSONObject(&quot;snippet&quot;).getString(&quot;title&quot;));

                    JSONObject idObject = video.getJSONObject(&quot;id&quot;);
                    if (idObject.has(&quot;videoId&quot;)) {
                        ytResponse.setVideoId(idObject.getString(&quot;videoId&quot;));
                        ytResponse.setVideoLink(&quot;https://www.youtube.com/watch?v=&quot; + ytResponse.getVideoId());
                    } else {
                        // based on my test, result might contains playlist. If the response is not a video, use N/A as the Id and link
                        ytResponse.setVideoId(&quot;N/A&quot;);
                        ytResponse.setVideoLink(&quot;N/A&quot;);
                    }
                    ytResponse.setChannelTitle(video.getJSONObject(&quot;snippet&quot;).getString(&quot;channelTitle&quot;));
                    ytResponse.setChannelId(video.getJSONObject(&quot;snippet&quot;).getString(&quot;channelId&quot;));
                    ytResponse.setChannelProfileLink(&quot;https://www.youtube.com/channel/&quot; + ytResponse.getChannelId());
                    ytResponse.setDescription(video.getJSONObject(&quot;snippet&quot;).getString(&quot;description&quot;));
                    ytResponse.setThumbnailUrl(video.getJSONObject(&quot;snippet&quot;).getJSONObject(&quot;thumbnails&quot;).getJSONObject(&quot;default&quot;).getString(&quot;url&quot;));
                    //System.out.println(ytResponse.toString());

                    if (snippet.has(&quot;tags&quot;)) {
                        List&lt;String&gt; tags = snippet.getJSONArray(&quot;tags&quot;).toList().stream()
                                .map(Object::toString)
                                .collect(Collectors.toList());
                        ytResponse.setTags(tags);
                    }


                    return ytResponse;
                })
                // collect all ytResponse into list
<span class="fc" id="L212">                .collect(Collectors.toList());</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>