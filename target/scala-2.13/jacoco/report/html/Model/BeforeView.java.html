<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BeforeView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">Model</a> &gt; <span class="el_source">BeforeView.java</span></div><h1>BeforeView.java</h1><pre class="source lang-java linenums">package Model;
import Model.SearchForm;
import Model.TextSegment;
import play.data.Form;
import play.mvc.*;
import play.i18n.MessagesApi;
import play.i18n.Messages;
import play.mvc.Http.Request;

import services.ReadabilityService;
import services.WordStatService;
import services.SentimentService;
import services.YTResponse;
import views.html.Home.display;
import views.html.Home.searchResults;
import play.data.FormFactory;
import views.html.Home.videoStatistics;

import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ExecutionException;

import static play.mvc.Results.ok;

/**
 * @author: Zheyi Zheng - 40266266
 * Created: 2024/11/7
 * This is the BeforeView class. This class response for keep all search records and process the search result out.
 */
public class BeforeView {
    // This ConcurrentHashMap will store search results regarding session
    // basically, each session has corrsponding arraylist (hold up to 10 search history), each arraylist has another arraylist of string to store result.
    private final ConcurrentHashMap&lt;String, ArrayList&lt;ArrayList&lt;ArrayList&lt;TextSegment&gt;&gt;&gt;&gt; userSearchResults;
    private final ConcurrentHashMap&lt;String, ArrayList&lt;String&gt;&gt; userKeywords;
    private final ConcurrentHashMap&lt;String, ArrayList&lt;ArrayList&lt;String&gt;&gt;&gt; userReadabilitys;

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/24
     * This is the constructor method. It initializes all three ConcurrentHashMap which will be used to store all information.
     */
    public BeforeView(){
<span class="nc" id="L44">        super();</span>
<span class="nc" id="L45">        userSearchResults = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L46">        userKeywords = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L47">        userReadabilitys = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L48">    }</span>

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/24
     * This is the process method. This method will take all information needed and provide the result view with needed information.
     * @param request request from user.
     * @param keyword the keyword that user searched for.
     * @param result the search result directly from YTRestDir.
     * @param formFactory formFactory
     * @param messagesApi messagesApi
     * @throws ExecutionException if some of the results from helper class is not ready
     * @throws InterruptedException if some of the threads got interrupt during processing.
     * @return The CompletableFuture of Result, can be directly use to pass to view.
     */
    public CompletableFuture&lt;Result&gt; process(Request request, String keyword, CompletableFuture&lt;List&lt;YTResponse&gt;&gt; result, FormFactory formFactory, MessagesApi messagesApi) throws ExecutionException, InterruptedException {
<span class="nc" id="L64">        String sessionId = getSessionId(request);</span>
<span class="nc" id="L65">        ArrayList&lt;ArrayList&lt;TextSegment&gt;&gt; currentResult = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L66">        return result.thenApply(list -&gt; {</span>
            // Get readability data
            ReadabilityService rs = new ReadabilityService(result);
            List&lt;Double&gt; listOfFRE = rs.getFre();
            List&lt;Double&gt; listOfFKGL = rs.getFkgl();
            SentimentService stm = new SentimentService(result);


            int index = 0;
            for (YTResponse ytResponse : list) {
                ArrayList&lt;TextSegment&gt; temp = new ArrayList&lt;&gt;();
                TextSegment title1 = new TextSegment(&quot;Title: &quot;, null);
                TextSegment title2 = new TextSegment(ytResponse.getTitle(), ytResponse.getVideoLink());
                TextSegment channel1 = new TextSegment(&quot;, Channel: &quot;, null);
                TextSegment channel2 = new TextSegment(ytResponse.getChannelTitle(), ytResponse.getChannelProfileLink());
                TextSegment description = new TextSegment(&quot;, Description: &quot; + ytResponse.getDescription(), null);

                // Check if readability data is ready, if not use N/A instead.
                String fkglValue = (listOfFKGL.size() &gt; index) ? listOfFKGL.get(index).toString() : &quot;N/A&quot;;
                String freValue = (listOfFRE.size() &gt; index) ? listOfFRE.get(index).toString() : &quot;N/A&quot;;

                TextSegment fkgl = new TextSegment(&quot;. Flesh-Kincaid Grade Level=&quot; + fkglValue, null);
                TextSegment fre = new TextSegment(&quot;, Flesch Reading Ease Score=&quot; + freValue, null);
                TextSegment tag = new TextSegment(&quot;Tags&quot;, null, ytResponse.getVideoId());
                TextSegment thumbnail = new TextSegment(&quot;thumbnail&quot;, ytResponse.getThumbnailUrl());

                // Form the search result.
                temp.add(title1);
                temp.add(title2);
                temp.add(channel1);
                temp.add(channel2);
                temp.add(description);
                temp.add(fkgl);
                temp.add(fre);
                temp.add(tag);
                temp.add(thumbnail);
                currentResult.add(temp);
                index++;
            }
            // Create/find the current user's ArrayList
            ArrayList&lt;ArrayList&lt;ArrayList&lt;TextSegment&gt;&gt;&gt; userList = userSearchResults.computeIfAbsent(sessionId, k -&gt; new ArrayList&lt;&gt;());
            ArrayList&lt;String&gt; userKeyword = userKeywords.computeIfAbsent(sessionId, k -&gt; new ArrayList&lt;&gt;());
            ArrayList&lt;ArrayList&lt;String&gt;&gt; userReadability = userReadabilitys.computeIfAbsent(sessionId, k -&gt; new ArrayList&lt;&gt;());
            // Add the result to the top of the list.
            userList.add(0, currentResult);
            userKeyword.add(0, keyword);
            userReadability.add(0, new ArrayList&lt;&gt;(Arrays.asList(rs.getAvgFKGL().toString(), rs.getAvgFRE().toString(),stm.getFinalOutput())));
            // Trim the list to make sure we only keep 10 most recent results
            if (userList.size() &gt; 10) {
                userList.remove(userList.size() - 1);
            }
            if (userKeyword.size() &gt; 10) {
                userKeyword.remove(userKeyword.size() - 1);
            }
            if (userReadability.size() &gt; 10) {
                userReadability.remove(userReadability.size() - 1);
            }
            // Create the search box
            Form&lt;SearchForm&gt; searchForm2 = formFactory.form(SearchForm.class);
            Messages messages = messagesApi.preferred(request);
            // pass everything to the view.
            return ok(searchResults.render(userKeyword, userList, userReadability, searchForm2, messages, request))
                    .withSession(request.session().adding(&quot;sessionId&quot;, sessionId));
        });
    }

    /**
     * Simple getSessionId method. This method will get session id from user request. If no id exist, it will create it.
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/10/24
     * @return The request
     */
    private String getSessionId(Request request){
        // Try to get session id from user request
<span class="nc" id="L140">        Optional&lt;String&gt; sessionId = request.session().get(&quot;sessionId&quot;);</span>
        // If there is a session id, return it. If not, create is randomly.
<span class="nc" id="L142">        return sessionId.orElseGet(() -&gt; UUID.randomUUID().toString());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>