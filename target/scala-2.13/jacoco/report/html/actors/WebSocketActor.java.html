<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSocketActor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">actors</a> &gt; <span class="el_source">WebSocketActor.java</span></div><h1>WebSocketActor.java</h1><pre class="source lang-java linenums">package actors;

import akka.actor.AbstractActor;
import akka.actor.ActorRef;
import akka.actor.OneForOneStrategy;
import akka.actor.Props;
import akka.actor.SupervisorStrategy;

import akka.japi.pf.DeciderBuilder;
import services.YTResponse;

import javax.inject.Inject;
import java.util.LinkedList;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeoutException;
import java.util.stream.Collectors;

/**
 * @author: Zheyi Zheng - 40266266
 * Created: 2024/11/14
 * This is the WebSocketActor class. This class keeps websocket with user, receive keyword from user,
 * forward keyword to APIActor, keep all search results and return all search results to user.
 * WebSocketActor is also the supervisor to all other actors. Home controller also only knows about WebSocketActor.
 */
public class WebSocketActor extends AbstractActor {

    private final ActorRef out;
    private ActorRef apiActor;
    private ActorRef readabilityActor;
    // keep searched keywords
    private List&lt;String&gt; searchHistory;
    // Keep search results
    private List&lt;List&lt;YTResponse&gt;&gt; searchResults;
<span class="fc" id="L35">    private final SupervisorStrategy strategy = new OneForOneStrategy(</span>
            -1,
<span class="fc" id="L37">            java.time.Duration.ofMinutes(3),</span>
<span class="fc" id="L38">            DeciderBuilder.match(TimeoutException.class,</span>
                    // Timeout exception, should be able to resolve in the next message, so resume.
                    e -&gt; SupervisorStrategy.resume()
<span class="fc" id="L41">            ).match(RuntimeException.class,</span>
                    // Runtime exception, probably not be able to get resolve by itself, restart it.
                    e -&gt; SupervisorStrategy.restart()
<span class="fc" id="L44">            ).matchAny(</span>
                    // Any other issue, escalate it to actor system.
                    e -&gt; SupervisorStrategy.escalate()
<span class="fc" id="L47">            ).build()</span>
    );

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/11/14
     * Define the supervise strategy.
     */
    @Override
    public SupervisorStrategy supervisorStrategy(){
<span class="fc" id="L57">        return strategy;</span>
    }

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/11/14
     * This is the constructor method.
     */
    @Inject
<span class="fc" id="L66">    public WebSocketActor(ActorRef out) {</span>
<span class="fc" id="L67">        this.out = out;</span>
<span class="fc" id="L68">        this.apiActor = getContext().actorOf(APIActor.getProps());</span>
<span class="fc" id="L69">        this.readabilityActor = getContext().actorOf(ReadabilityActor.getProps());</span>
<span class="fc" id="L70">        this.searchHistory = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L71">        this.searchResults = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L72">    }</span>

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/11/14
     * This is the getProps method. This method allows Props create APIActor.
     * @param out from Flow.
     * @return Props Proper return object in Akka
     */
    static public Props props(ActorRef out) {
<span class="fc" id="L82">        return Props.create(WebSocketActor.class, () -&gt; new WebSocketActor(out));</span>
    }

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/11/14
     * This is the createReceive method. This method distinguish messages.
     * If the message is a string class, then it's a request message from user. Add the keyword to list and send keyWordSearch message to APIActor.
     * If the message is a CompletableFuture, then this is a response from APIActor. Read the information out and return new result to user.
     * @return Receive proper return object in Akka
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public Receive createReceive() {
<span class="fc" id="L96">        return receiveBuilder()</span>
<span class="fc" id="L97">                .match(String.class, keyword -&gt; {</span>
                    System.out.println(&quot;Received keyword: &quot; + keyword);
                    if (searchHistory.size() &gt;= 10) {
                        // Remove the oldest entry if size exceeds 10
                        searchHistory.remove(0);
                    }
                    // Store the keyword in search history
                    searchHistory.add(keyword);

                    // Forward the keyword to the APIActor for processing
                    apiActor.tell(new ProjectProtocol.KeyWordSearch(keyword, null, null), getSelf());
                })
<span class="fc" id="L109">                .match(CompletableFuture.class, future -&gt; {</span>
                    // Wait for the APIActor to return the search results
                    future.thenAccept(results -&gt; {
                        // Send a message to the ReadabilityActor
                        readabilityActor.tell(new ProjectProtocol.ReadabilityCheck(future), getSelf());
                        // Store the result in search results, only keep 10 most recent results
                        if (searchResults.size() &gt;= 10) {
                            searchResults.remove(0);
                        }
                        searchResults.add((List&lt;YTResponse&gt;) results);
                    });
                })
<span class="fc" id="L121">                .match(ProjectProtocol.ReadabilityResponse.class, message -&gt; {</span>
                    // Receive readability response from the ReadabilityActor
                    double avgFRE = message.avgFRE;
                    double avgFKGL = message.avgFKGL;
                    List&lt;Double&gt; fre = message.fre;
                    List&lt;Double&gt; fkgl = message.fkgl;
                    for (int i=0; i&lt;searchResults.get(searchResults.size()-1).size(); i++){
                        searchResults.get(0).get(i).setFre(fre.get(i));
                        searchResults.get(0).get(i).setFkgl(fkgl.get(i));
                    }
                    // Send message back
                    String response = avgFKGL + &quot;\n&quot; + avgFRE + &quot;\n&quot;;
                    response += searchResults.get(searchResults.size()-1).stream()
                            .map(result -&gt; result.toHTMLString())
                            .collect(Collectors.joining(&quot;\n&quot;));

                    System.out.println(&quot;Sending results: \n&quot; + response);
                    // Send the result back to the WebSocket client
                    out.tell(response, getSelf());
                })
<span class="fc" id="L141">                .match(ProjectProtocol.UpdateApiAndReadabilityRef.class, message -&gt;{</span>
                    // This should not be used, it is created for test purpose.
                    this.apiActor=message.apiActor;
                    this.readabilityActor=message.readabilityActor;
                })
<span class="fc" id="L146">                .build();</span>
    }

    /**
     * @author: Zheyi Zheng - 40266266
     * Created: 2024/11/14
     * This is the postStop method. This method cleanup resources when the actor is stopped.
     */
    @Override
    public void postStop() throws Exception {
        // Cleanup resources when the actor is stopped
<span class="fc" id="L157">        super.postStop();</span>
<span class="fc" id="L158">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>